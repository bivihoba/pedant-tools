#!/usr/bin/python

import __init__,os,sys,uuid,glob,argparse,re,json,atexit,time

# cmd_folder = os.path.realpath( __file__ + '/../../lib/python/' )
# if cmd_folder not in sys.path:
# 	sys.path.insert(0, cmd_folder)

from pedant.screenshots.Application import Application 

#parse arguments
parser = argparse.ArgumentParser()
parser.add_argument( "-m", "--mode", type=str , help="Pedant working mode from config", default='fast')
parser.add_argument( "-log", "--logging", type=bool , help="Need write log?", default=False)
args = parser.parse_args()

app = Application()
config = app.getProjectConfig( os.getcwd() )

if not config['modes'].has_key( args.mode ):
	print ">Error: Mode <" + args.mode + "> is not found in project configuration. Exit"
	exit(1)

if len( config['modes'][args.mode] ) < 1:
	print ">Error: Browsers not found in "+ args.mode +" mode. Exit"
	exit(1)

#where pedant save\search all results
config[ 'data_storage_root' ] = os.path.realpath( sys.argv[0] + os.sep + '/'+ os.sep +'..'+ os.sep +'..'+ os.sep +'web'+ os.sep +'data_storage' ) + os.sep + config['prj_name']
#where is locate data_storage folder for curent project
#sources to be checked
config[ 'urls' ] = app.find_sources_in_directory( os.getcwd(), (".html",".htm") ,config[ 'url_mask' ], config['prj_name'] )
config['logging'] = args.logging

if len( config[ 'urls' ] ) < 1:
	print 'Pedant not found items for checking in current folder and in config'
	sys.exit(0)

app.configure( config, args.mode )

if ( not app.lock() ):
	lock_path = config['prj_data_storage'] + os.sep + 'lock.file'
	print ">Error: Your project is locked. Stop all pedant-screens processes and remove file:"+ lock_path +" for continue"
	exit(1)

#register unlock function before exit from process
atexit.register( app.unlock )

#run application
app.start()
#t = app.start_in_thread()# - start thread mode
#time.sleep(8)
#app.stop()# -stop thread
#while app.state() is False:
#	pass